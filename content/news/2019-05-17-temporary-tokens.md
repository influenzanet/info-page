---
title: Token-based Authentication
date: 2019-05-17T12:29:54+01:00
draft: false
tags:
- technical documentation
- token
- authentication
---
*This is the first one in a series of posts about selected topics regarding the InfluenzaNet 2.0 development. We face many small or big choices during the development phase, and through this series we try to give you a quick glance on the backgrounds and thought processes.*

InfluenzaNet is becoming a cloud-based distributed system with microservices running on the  server-cluster and multiple clients. In such a system, different authentication strategies are necessary to cover a variety of requirements regarding both, usability and security. We are working on a more detailed article on the topic of authentication which we will post here later.  The goal of this post is to provide an overview over token-based authentication in InfluenzaNet and especially on how temporary tokens can be used in the new system.

Token-based authentication (e.g., using the JSON web-token method) is a de facto standard for web-based services, but to get a good understanding of the procedures, we start with a short explanation of the main concept for this form of authentication:

Once a user proved his identity via providing login credentials, we want to know for each following interaction with the server  that this is the same user, without the need of sending the user credentials again every time. Tokens are basically strings that the server generates and signs for a client after the user authenticated. The client will attach this string to messages/requests sent to the server to prove its identity.
As a short summary, tokens can be used as a kind of key to grant the user access to specific resources.

But what are tokens exactly?
As mentioned above, tokens are strings that are generated by the server. These strings contain information that the server uses to identify the user and are cryptographically signed by the server to check the authenticity (that it was originally generated by the server and not altered by another entity). To make tokens as secure as possible, they should come with an expiry mechanism. This can either be a condition that needs to be fulfilled, e.g., token was used, or the end of a time period that is reached. In case sensitive information is included within and transported with the token, the token also should be hashed. This is a technique to make the string unreadable, so that hackers cannot get the information from the tokens, even when they get access to them. Further information on hashing as well as on how to make tokens secure, can be found [here](https://web.archive.org/web/20190509072528/https://crackstation.net/hashing-security.htm).

With InfluenzaNet, we also decided to use temporary tokens (TempToken), a slightly different concept of tokens, than described above. TempTokens or temporary tokens are created to be available and valid only for a single usage. The special feature of this type of token is that it is deleted immediately after use or after a specific time period passed, whatever comes first. Each TempToken is uniquely generated by the server and saved as a database entry with some context information (e.g., user id, purpose, expiration date, etc.). For InfluenzaNet, we implemented a unique string generator inspired by the concept of Universally Unique Lexicographically Sortable Identifiers (as implemented, e.g., [here](https://github.com/oklog/ulid)). The first part of the generated string encodes the current timestamp in milliseconds, and the second part contains newly created random list of alphanumeric characters. With this method, even running multiple instances of the same service for generating these strings, the chance of having duplicates is very low. (The probability that two strings, generated at the exact same millisecond, are identical, is 1 to 1,208,925,819,614,629,174,706,176.) These attributes are essential for those kinds of use cases, in which it is important that the tokens can only be used once.

When the user requests a specific action, such as a password reset the system generates a temporary token and stores the token in the database. The token is then passed to the user, e.g., via a link in an email. By clicking on the link in the email, the user will send a request with the token to the system. The system then checks if the token is in the database and is valid. If that is the case, the request of the user will be performed, e.g., the user is able to reset the password. After that the token will be deleted from the database, to make sure that the request cannot be performed twice with the same token.

Possible use cases for TempTokens besides resetting the password are confirming an email address, filling out surveys or invitations to InfluenzaNet.

**Password Reset**
In case, a user requests a password reset, a TempToken is generated and an email with a link including this token is sent to the user. If the user tries to use this token, it is first checked whether the token is present in the database and valid. If this is the case, the user can reset the password and the token is deleted and so any further use prevented.

**Changing Email Address**
When a user enters a new email address to the system, we can use temporary tokens for 1) confirming the user owns the given email address, and 2) resetting to the old email address in case, the replacement was not intended by the user. In these use cases, an email with a temporary token is sent to the respective email address.  Since the sent tokens are unique and bound to a specific user, time frame and purpose, the user can confirm her identity by simply possessing the correct token string. Practically this could mean calling the URL token address by clicking on it from the email.

**Temporary/Loginless Access To fill out Surveys**
In InfluenzaNet, participants receive surveys regularly. To increase response rates, we want to make the process of filling out surveys as easy as possible. In case of an email notification, the user can simply click the link from the email, which will forward the user directly to the survey and open a temporary session, which is authenticated for the duration until the survey is submitted or saved. For this, we also use these temporary tokens, where the database entry contains specific information about to which user and which survey it is assigned to.

**Invitation**
An idea to increase the number of participants is to allow users to invite their friends and relatives to InfluenzaNet. By doing so, they could earn rewards when someone registers using the invitation link. This link that includes a temporary token token is sent to the invited person. When the link is clicked, this token or more specifically, the information stored with it in the database, can be used to identify which user sent the invitation and add the reward. In this case, it is important that the token is deleted as soon as it was used, otherwise the user would have the possibility to use the token again and receive several rewards for a single invitation.

*Daniel*
